(()=>{"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(t)}function o(t){var o=function(t,o){if("object"!=e(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=e(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(o)?o:o+""}function i(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,o(n.key),n)}}function n(t,e,o){return e&&i(t.prototype,e),o&&i(t,o),Object.defineProperty(t,"prototype",{writable:!1}),t}function s(t,e,i){return(e=o(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function r(t){return t.split("-")}var a={};function u(){return Array(3).fill(0).map((function(){return Math.ceil(255*Math.random())})).concat(255).join("-")}function c(t,e){(null==e||e>t.length)&&(e=t.length);for(var o=0,i=new Array(e);o<e;o++)i[o]=t[o];return i}function l(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var o=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=o){var i,n,s,r,a=[],u=!0,c=!1;try{if(s=(o=o.call(t)).next,0===e){if(Object(o)!==o)return;u=!1}else for(;!(u=(i=s.call(o)).done)&&(a.push(i.value),a.length!==e);u=!0);}catch(t){c=!0,n=t}finally{try{if(!u&&null!=o.return&&(r=o.return(),Object(r)!==r))return}finally{if(c)throw n}}return a}}(t,e)||function(t,e){if(t){if("string"==typeof t)return c(t,e);var o=Object.prototype.toString.call(t).slice(8,-1);return"Object"===o&&t.constructor&&(o=t.constructor.name),"Map"===o||"Set"===o?Array.from(t):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?c(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(t,o){if(o&&("object"===e(o)||"function"==typeof o))return o;if(void 0!==o)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function f(t){return f=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},f(t)}function d(t,e){return d=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},d(t,e)}function v(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&d(t,e)}var y=function(){return n((function e(){t(this,e),s(this,"listeners",void 0),s(this,"id",void 0),this.id=function(){for(var t=u();a[t];)t=u();return t}(),this.listeners={}}),[{key:"draw",value:function(t,e,o){throw new Error("Method not implemented.")}},{key:"on",value:function(t,e){this.listeners[t]?this.listeners[t].push(e):this.listeners[t]=[e]}},{key:"getListeners",value:function(){return this.listeners}},{key:"getId",value:function(){return this.id}}])}();function p(t,e,o){return e=f(e),h(t,m()?Reflect.construct(e,o||[],f(t).constructor):e.apply(t,o))}function m(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(m=function(){return!!t})()}var w=function(e){function o(e){var i;return t(this,o),(i=p(this,o)).props=e,i.props.fillColor=e.fillColor||"#fff",i.props.strokeColor=e.strokeColor||"#000",i.props.strokeWidth=e.strokeWidth||1,i}return v(o,e),n(o,[{key:"draw",value:function(t,e,o){var i=this.props,n=i.x,s=i.y,a=i.width,u=i.height,c=i.strokeColor,h=i.strokeWidth,f=i.fillColor;t.save(),t.beginPath(),t.strokeStyle=c,t.lineWidth=h,t.fillStyle=f,t.rect(n*o,s*o,a*o,u*o),t.fill(),t.stroke(),t.restore();var d=l(r(this.id),4),v=d[0],y=d[1],p=d[2],m=d[3];e.save(),e.beginPath(),e.strokeStyle="rgba(".concat(v,", ").concat(y,", ").concat(p,", ").concat(m,")"),e.fillStyle="rgba(".concat(v,", ").concat(y,", ").concat(p,", ").concat(m,")"),e.rect(n*o,s*o,a*o,u*o),e.fill(),e.stroke(),e.restore()}}])}(y);function b(t,e,o){return e=f(e),h(t,x()?Reflect.construct(e,o||[],f(t).constructor):e.apply(t,o))}function x(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(x=function(){return!!t})()}var g=function(e){function o(e){var i;return t(this,o),(i=b(this,o)).props=e,i.props.fillColor=e.fillColor||"#fff",i.props.strokeColor=e.strokeColor||"#000",i.props.strokeWidth=e.strokeWidth||1,i}return v(o,e),n(o,[{key:"draw",value:function(t,e,o){var i=this.props,n=i.x,s=i.y,a=i.radius,u=i.strokeColor,c=i.strokeWidth,h=i.fillColor;t.save(),t.beginPath(),t.fillStyle=h,t.strokeStyle=u,t.lineWidth=c,t.arc(n*o,s*o,a*o,0,2*Math.PI),t.fill(),t.stroke(),t.restore();var f=l(r(this.id),4),d=f[0],v=f[1],y=f[2],p=f[3];e.save(),e.beginPath(),e.fillStyle="rgba(".concat(d,", ").concat(v,", ").concat(y,", ").concat(p,")"),e.strokeStyle="rgba(".concat(d,", ").concat(v,", ").concat(y,", ").concat(p,")"),e.lineWidth=c,e.arc(n*o,s*o,a*o,0,2*Math.PI),e.fill(),e.stroke(),e.restore()}}])}(y),S=function(t){return t.click="click",t.mousedown="mousedown",t.mousemove="mousemove",t.mouseup="mouseup",t.mouseenter="mouseenter",t.mouseleave="mouseleave",t}({}),k=function(t){return t.Down="DOWN",t.Up="Up",t.Move="MOVE",t}({}),M=function(){return n((function e(){t(this,e),s(this,"listenersMap",{}),s(this,"lastDownId",void 0),s(this,"lastMoveId",void 0)}),[{key:"addAction",value:function(t,e){var o=this,i=t.type,n=t.id;s(s(s({},k.Move,(function(){o.fire(n,S.mousemove,e),o.lastMoveId&&o.lastMoveId===n||(o.fire(n,S.mouseenter,e),o.fire(o.lastMoveId,S.mouseleave,e))})),k.Down,(function(){o.fire(n,S.mousedown,e)})),k.Up,(function(){o.fire(n,S.mouseup,e),o.lastDownId===n&&o.fire(n,S.click,e)}))[i](),i===k.Move?this.lastMoveId=t.id:i===k.Down&&(this.lastDownId=t.id)}},{key:"addListeners",value:function(t,e){this.listenersMap[t]=e}},{key:"fire",value:function(t,e,o){this.listenersMap[t]&&this.listenersMap[t][e]&&this.listenersMap[t][e].forEach((function(t){return t(o)}))}}])}();function O(t,e){(null==e||e>t.length)&&(e=t.length);for(var o=0,i=new Array(e);o<e;o++)i[o]=t[o];return i}var C=new(function(){return n((function e(o){var i=this;t(this,e),s(this,"canvas",void 0),s(this,"osCanvas",void 0),s(this,"ctx",void 0),s(this,"osCtx",void 0),s(this,"dpr",void 0),s(this,"shapes",new Set),s(this,"eventSimulator",void 0),s(this,"width",void 0),s(this,"height",void 0),s(this,"mousePosition",{x:0,y:0}),s(this,"maxScale",8),s(this,"minScale",.4),s(this,"scaleStep",.06),s(this,"scale",void 0),s(this,"preScale",void 0),s(this,"offset",{x:0,y:0}),s(this,"curOffset",{x:0,y:0}),s(this,"x",0),s(this,"y",0),s(this,"nodes",[]),s(this,"_onMousemove",void 0),s(this,"_onMouseup",void 0),s(this,"handleCreator",(function(t){return function(e){var o=e.offsetX,n=e.offsetY,s=i.hitJudge(o,n);i.eventSimulator.addAction({type:t,id:s},e)}})),this.init(o),this.initEventListener(),this.eventSimulator=new M}),[{key:"init",value:function(t){var e=window.devicePixelRatio;t.width=parseInt(t.style.width)*e,t.height=parseInt(t.style.height)*e,this.width=t.width,this.height=t.height,this.canvas=t,this.osCanvas=new OffscreenCanvas(t.width,t.height),this.ctx=this.canvas.getContext("2d"),this.osCtx=this.osCanvas.getContext("2d"),this.ctx.scale(e,e),this.osCtx.scale(e,e),this.dpr=e,this.scale=e,this.preScale=e}},{key:"initEventListener",value:function(){var t=this;this.canvas.addEventListener("mousedown",this.handleCreator(k.Down)),this.canvas.addEventListener("mouseup",this.handleCreator(k.Up)),this.canvas.addEventListener("mousemove",this.handleCreator(k.Move)),this.canvas.addEventListener("mousewheel",(function(e){return t.onMousewheel(e)})),this.canvas.addEventListener("mousedown",(function(e){return t.onMousedown(e)})),this._onMousemove=this.onMousemove.bind(this),this._onMouseup=this.onMouseup.bind(this)}},{key:"add",value:function(t){var e=t.getId();this.eventSimulator.addListeners(e,t.getListeners()),this.shapes.add(e),this.nodes.push(t),this.draw(t)}},{key:"draw",value:function(t){if(t)t.draw(this.ctx,this.osCtx,this.scale);else{var e,o=function(t,e){var o="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!o){if(Array.isArray(t)||(o=function(t,e){if(t){if("string"==typeof t)return O(t,e);var o=Object.prototype.toString.call(t).slice(8,-1);return"Object"===o&&t.constructor&&(o=t.constructor.name),"Map"===o||"Set"===o?Array.from(t):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?O(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){o&&(t=o);var i=0,n=function(){};return{s:n,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){o=o.call(t)},n:function(){var t=o.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==o.return||o.return()}finally{if(a)throw s}}}}(this.nodes);try{for(o.s();!(e=o.n()).done;)e.value.draw(this.ctx,this.osCtx,this.scale)}catch(t){o.e(t)}finally{o.f()}}}},{key:"hitJudge",value:function(t,e){var o=Array.from(this.osCtx.getImageData(t*this.dpr,e*this.dpr,1,1).data).join("-");return this.shapes.has(o)?o:void 0}},{key:"onMousewheel",value:function(t){if(t.preventDefault(),this.mousePosition.x=t.offsetX,this.mousePosition.y=t.offsetY,t.deltaY<0){if(this.scale=parseFloat((this.scaleStep+this.scale).toFixed(2)),this.scale>this.maxScale)return void(this.scale=this.maxScale)}else if(this.scale=parseFloat((this.scale-this.scaleStep).toFixed(2)),this.scale<this.minScale)return void(this.scale=this.minScale);this.zoom()}},{key:"zoom",value:function(){this.offset.x=this.mousePosition.x-(this.mousePosition.x-this.offset.x)*this.scale/this.preScale,this.offset.y=this.mousePosition.y-(this.mousePosition.y-this.offset.y)*this.scale/this.preScale,this.paint(),this.preScale=this.scale,this.curOffset.x=this.offset.x,this.curOffset.y=this.offset.y}},{key:"clear",value:function(){this.canvas.width=this.width,this.osCtx.canvas.width=this.width}},{key:"paint",value:function(){this.clear(),this.ctx.translate(this.offset.x,this.offset.y),this.osCtx.translate(this.offset.x,this.offset.y),this.ctx.scale(this.scale,this.scale),this.osCtx.scale(this.scale,this.scale),this.draw()}},{key:"zoomIn",value:function(){this.scale=parseFloat((this.scaleStep+this.scale).toFixed(2)),this.scale>this.maxScale?this.scale=this.maxScale:(this.mousePosition.x=this.width/2,this.mousePosition.y=this.height/2,this.zoom())}},{key:"zoomOut",value:function(){this.scale=parseFloat((this.scale-this.scaleStep).toFixed(2)),this.scale<this.minScale?this.scale=this.minScale:(this.mousePosition.x=this.width/2,this.mousePosition.y=this.height/2,this.zoom())}},{key:"onMousedown",value:function(t){console.log("onMousedown"),0===t.button&&(this.x=t.x,this.y=t.y,window.addEventListener("mousemove",this._onMousemove),window.addEventListener("mouseup",this._onMouseup))}},{key:"onMousemove",value:function(t){this.offset.x=this.curOffset.x+(t.x-this.x),this.offset.y=this.curOffset.y+(t.y-this.y),this.paint()}},{key:"onMouseup",value:function(){this.curOffset.x=this.offset.x,this.curOffset.y=this.offset.y,window.removeEventListener("mousemove",this._onMousemove),window.removeEventListener("mouseup",this._onMouseup)}},{key:"reset",value:function(){this.clear(),this.scale=this.dpr,this.preScale=this.dpr,this.offset={x:0,y:0},this.curOffset={x:0,y:0},this.mousePosition={x:0,y:0},this.draw()}}])}())(document.querySelector("#canvas")),P=new w({x:50,y:50,width:150,height:100,fillColor:"green"}),j=new g({x:200,y:250,radius:50,fillColor:"red"});P.on(S.mousedown,(function(){return console.log("rect mousedown")})),P.on(S.mouseup,(function(){return console.log("rect mouseup")})),P.on(S.mouseenter,(function(){return console.log("rect mouseenter")})),P.on(S.click,(function(){return console.log("rect click")})),j.on(S.click,(function(){return console.log("circle click!!")})),j.on(S.mouseleave,(function(){return console.log("circle mouseleave!")})),C.add(P),C.add(j),document.querySelector("#zoomIn").addEventListener("click",(function(){C.zoomIn()})),document.querySelector("#zoomOut").addEventListener("click",(function(){C.zoomOut()})),document.querySelector("#reset").addEventListener("click",(function(){C.reset()}))})();